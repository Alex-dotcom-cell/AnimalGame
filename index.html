<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Animal Letter Game ‚Äì Deutsch</title>
    <style>
      :root {
        --bg: #87cefa;
        --black: #000;
        --gray: #c8c8c8;
        --dark-gray: #969696;
        --box-size: 48px;
        --letter-font-size: 32px;
        --mobile-box-size: 40px;
        --mobile-letter-font-size: 24px;
      }
      
      html, body {
        height: 100%;
        margin: 0;
        font-family: Arial, Helvetica, sans-serif;
        background: var(--bg);
        overflow-x: hidden;
      }
      
      .wrap {
        max-width: 1400px;
        margin: 0 auto;
        padding: 12px;
        box-sizing: border-box;
      }
      
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
      
      header h1 {
        margin: 0;
        font-size: 22px;
        color: #013a63;
        flex: 1;
        min-width: 200px;
      }
      
      .controls-top {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      
      .btn {
        padding: 10px 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
      }
      
      .btn-primary {
        background: #0066cc;
        color: white;
      }
      
      .btn-secondary {
        background: #ff9900;
        color: white;
      }
      
      .btn-danger {
        background: #cc3333;
        color: white;
      }
      
      .btn-success {
        background: #00a86b;
        color: white;
      }
      
      .btn:hover {
        opacity: 0.9;
        transform: translateY(-2px);
      }
      
      .game-area {
        display: flex;
        gap: 16px;
        align-items: flex-start;
      }
      
      .left, .right {
        background: rgba(255, 255, 255, 0.9);
        padding: 12px;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        box-sizing: border-box;
      }
      
      .left {
        flex: 1 1 640px;
        min-width: 0;
      }
      
      .right {
        width: 360px;
      }
      
      .animal-image {
        max-width: 100%;
        height: auto;
        max-height: 400px;
        object-fit: contain;
        display: block;
        margin: 6px auto;
      }
      
      .boxes {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px;
        margin: 14px 0;
      }
      
      .box {
        width: var(--box-size);
        height: var(--box-size);
        background: var(--gray);
        border: 2px solid var(--black);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--letter-font-size);
        font-weight: 700;
      }
      
      .alphabet {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 12px;
        margin-top: 8px;
        justify-content: center;
      }
      
      .letter-btn {
        width: 40px;
        height: 40px;
        background: var(--gray);
        border-radius: 6px;
        border: 1px solid #666;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        user-select: none;
        font-size: 20px;
        font-weight: bold;
        transition: all 0.2s;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }
      
      .letter-btn:hover, .letter-btn:active {
        background: var(--dark-gray);
        color: white;
      }
      
      .section-title {
        font-weight: 700;
        color: #054f85;
        margin-bottom: 8px;
        font-size: 18px;
      }
      
      .preview {
        min-height: 120px;
        padding: 8px;
        font-size: 14px;
        color: #222;
      }
      
      .status {
        margin-top: 8px;
        font-weight: 600;
      }
      
      canvas#particles {
        position: absolute;
        left: 0;
        top: 0;
        pointer-events: none;
        z-index: 10;
      }
      
      .footer {
        margin-top: 10px;
        color: #333;
        font-size: 14px;
      }
      
      .sound-controls {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        flex-wrap: wrap;
      }
      
      .sound-btn {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        background: white;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      
      .sound-btn.active {
        background: #e0e0e0;
      }
      
      /* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
      @media (max-width: 1100px) {
        .game-area {
          flex-direction: column;
        }
        
        .right {
          width: 100%;
        }
      }
      
      @media (max-width: 768px) {
        .wrap {
          padding: 8px;
        }
        
        header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        
        .controls-top {
          width: 100%;
          justify-content: space-between;
        }
        
        header h1 {
          font-size: 18px;
        }
        
        .btn {
          padding: 12px;
          font-size: 16px;
          margin-bottom: 5px;
        }
        
        .left, .right {
          padding: 10px;
        }
        
        .animal-image {
          max-height: 300px;
        }
        
        .box {
          width: var(--mobile-box-size);
          height: var(--mobile-box-size);
          font-size: var(--mobile-letter-font-size);
        }
        
        .letter-btn {
          width: 36px;
          height: 36px;
          font-size: 18px;
        }
        
        .alphabet {
          gap: 6px;
          padding: 8px;
        }
        
        .section-title {
          font-size: 16px;
        }
        
        .preview {
          min-height: 100px;
          font-size: 13px;
        }
        
        .sound-controls {
          flex-direction: column;
        }
        
        .sound-btn {
          width: 100%;
          justify-content: center;
        }
      }
      
      @media (max-width: 480px) {
        .box {
          width: 35px;
          height: 35px;
          font-size: 20px;
        }
        
        .letter-btn {
          width: 32px;
          height: 32px;
          font-size: 16px;
        }
        
        .alphabet {
          gap: 4px;
        }
        
        .animal-image {
          max-height: 250px;
        }
      }
      
      @media (max-width: 360px) {
        .box {
          width: 30px;
          height: 30px;
          font-size: 18px;
        }
        
        .letter-btn {
          width: 28px;
          height: 28px;
          font-size: 14px;
        }
        
        .alphabet {
          gap: 3px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>Animal Letter Game ‚Äì Deutsch</h1>
        <div class="controls-top">
          <button id="startBtn" class="btn btn-primary">Start / –ò–≥—Ä–∞—Ç—å</button>
          <button id="undoBtn" class="btn btn-secondary" disabled>–û—Ç–º–µ–Ω–∞</button>
          <button id="resetBtn" class="btn btn-danger">–°–±—Ä–æ—Å</button>
        </div>
      </header>

      <div style="position: relative">
        <!-- particle canvas -->
        <canvas
          id="particles"
          width="1600"
          height="1200"
          style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"
        ></canvas>

        <div class="game-area">
          <div class="left">
            <div style="text-align: center">
              <img id="animalImg" class="animal-image" alt="animal" />
            </div>

            <div class="section-title">–°–ª–æ–≤–æ:</div>
            <div id="boxes" class="boxes" aria-hidden="true"></div>

            <div class="section-title">–ê–ª—Ñ–∞–≤–∏—Ç (BIG / SMALL)</div>
            <div
              id="alphabetBig"
              class="alphabet"
              aria-label="–ë–æ–ª—å—à–∏–µ –±—É–∫–≤—ã"
            ></div>
            <div
              id="alphabetSmall"
              class="alphabet"
              aria-label="–ú–∞–ª–µ–Ω—å–∫–∏–µ –±—É–∫–≤—ã"
              style="margin-top: 10px"
            ></div>
          </div>

          <div class="right">
            <div class="section-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            <div class="preview">
              <div>
                <strong>–¢–µ–∫—É—â–µ–µ —Å–ª–æ–≤–æ:</strong>
                <span id="currentWordPreview">‚Äî</span>
              </div>
              <div>
                <strong>–ü–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –±—É–∫–≤:</strong>
                <span id="placedCount">0</span> / <span id="totalLetters">0</span>
              </div>
              <div class="status" id="message"></div>
            </div>

            <div style="margin-top: 14px">
              <div class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
              <button
                id="nextBtn"
                class="btn btn-success"
                style="width: 100%;"
              >
                –°–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ
              </button>
              
              <div class="section-title" style="margin-top: 15px;">–ó–≤—É–∫</div>
              <div class="sound-controls">
                <button id="soundToggle" class="sound-btn active">
                  üîä –ó–≤—É–∫–∏ –≤–∫–ª
                </button>
                <button id="musicToggle" class="sound-btn active">
                  üéµ –ú—É–∑—ã–∫–∞ –≤–∫–ª
                </button>
              </div>
            </div>

            <div class="footer">
              <p>
                –ö–ª–∏–∫–∞–π –Ω–∞ –±—É–∫–≤—ã, —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∫–ª–µ—Ç–∫–∏. –ï—Å–ª–∏ –±—É–∫–≤–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç ‚Äî –∏–≥—Ä–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–≤—É–∫.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==== –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ====
      const ASSETS_DIR = "./assets";

      // –ê–ª—Ñ–∞–≤–∏—Ç
      const lettersBig = Array.from(Array(26))
        .map((_, i) => String.fromCharCode(65 + i))
        .concat(["√Ñ", "√ñ", "√ú", "√ü"]);
      const lettersSmall = Array.from(Array(26))
        .map((_, i) => String.fromCharCode(97 + i))
        .concat(["√§", "√∂", "√º", "√ü"]);

      // –°–ø–∏—Å–æ–∫ –∂–∏–≤–æ—Ç–Ω—ã—Ö
      const animals = [
        { name: "Affe", img: "Affe.png" },
        { name: "Katze", img: "Katze.png" },
        { name: "Maus", img: "Maus.png" },
        { name: "Dino", img: "Dino.png" },
        { name: "Vogel", img: "Vogel.png" },
        { name: "Esel", img: "Esel.png" },
        { name: "Qualle", img: "Qualle.png" },
        { name: "Osterhase", img: "Osterhase.png" },
        { name: "Igel", img: "Igel.png" },
        { name: "Tisch", img: "Tisch .png" },
        { name: "Lampe", img: "Lampe.png" },
        { name: "Gabel", img: "Gabel.png" },
        { name: "Xylophon", img: "Xylophon.png" },
        { name: "Junge", img: "Junde.png" },
        { name: "Nase", img: "Nase.png" },
        { name: "Sonne", img: "Sonne.png" },
        { name: "Baum", img: "Baum.png" },
        { name: "Pinsel", img: "Pinsel.png" },
        { name: "Feder", img: "Feder.png" },
        { name: "Uhr", img: "Uhr.png" },
        { name: "Wolke", img: "Wolke.png" },
        { name: "Rakete", img: "Rakete.png" },
      ];

      // –ê—É–¥–∏–æ
      const audioBg = new Audio(ASSETS_DIR + "/background.wav");
      audioBg.loop = true;
      audioBg.volume = 0.2;

      const sndFirework = new Audio(ASSETS_DIR + "/firework.wav");
      const sndCorrect = new Audio(ASSETS_DIR + "/correct.wav");
      const sndWrong = new Audio(ASSETS_DIR + "/wrong.wav");

      // ==== –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã ====
      let currentIndex = 0;
      let currentWord = animals[currentIndex].name.split("");
      let playerLetters = new Array(currentWord.length).fill("");
      let showFullWord = false;
      let fullWordStartTime = 0;
      let particles = [];
      let particlesRunning = false;
      let actionHistory = []; // –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
      let soundsEnabled = true;
      let musicEnabled = true;
      let lastTapTime = 0; // –î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–≤–æ–π–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π

      // DOM refs
      const animalImg = document.getElementById("animalImg");
      const boxesContainer = document.getElementById("boxes");
      const alphabetBigDiv = document.getElementById("alphabetBig");
      const alphabetSmallDiv = document.getElementById("alphabetSmall");
      const currentWordPreview = document.getElementById("currentWordPreview");
      const placedCount = document.getElementById("placedCount");
      const totalLetters = document.getElementById("totalLetters");
      const messageEl = document.getElementById("message");
      const startBtn = document.getElementById("startBtn");
      const nextBtn = document.getElementById("nextBtn");
      const undoBtn = document.getElementById("undoBtn");
      const resetBtn = document.getElementById("resetBtn");
      const soundToggle = document.getElementById("soundToggle");
      const musicToggle = document.getElementById("musicToggle");

      // Canvas particles
      const canvas = document.getElementById("particles");
      const ctx = canvas.getContext("2d");

      // –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ canvas
      function resizeCanvas() {
        const container = document.querySelector('.wrap');
        const rect = container.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
      }

      window.addEventListener("resize", resizeCanvas);
      window.addEventListener("load", resizeCanvas);
      setTimeout(resizeCanvas, 300);

      // ==== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI ====
      function renderAlphabet() {
        alphabetBigDiv.innerHTML = "";
        lettersBig.forEach((letter) => {
          const b = document.createElement("div");
          b.className = "letter-btn";
          b.textContent = letter;
          b.dataset.letter = letter;
          b.setAttribute("role", "button");
          b.setAttribute("aria-label", `–ë—É–∫–≤–∞ ${letter}`);
          alphabetBigDiv.appendChild(b);
        });
        
        alphabetSmallDiv.innerHTML = "";
        lettersSmall.forEach((letter) => {
          const b = document.createElement("div");
          b.className = "letter-btn";
          b.textContent = letter;
          b.dataset.letter = letter;
          b.setAttribute("role", "button");
          b.setAttribute("aria-label", `–ë—É–∫–≤–∞ ${letter}`);
          alphabetSmallDiv.appendChild(b);
        });
      }

      function renderBoxes() {
        boxesContainer.innerHTML = "";
        playerLetters.forEach((ch, i) => {
          const box = document.createElement("div");
          box.className = "box";
          box.textContent = ch || "";
          box.setAttribute("aria-label", ch ? `–ë—É–∫–≤–∞ ${ch}` : "–ü—É—Å—Ç–∞—è –∫–ª–µ—Ç–∫–∞");
          boxesContainer.appendChild(box);
        });
        currentWordPreview.textContent = currentWord.join("");
        placedCount.textContent = playerLetters.filter((x) => x !== "").length;
        totalLetters.textContent = currentWord.length;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
        undoBtn.disabled = actionHistory.length === 0;
      }

      function loadAnimalImage() {
        const animal = animals[currentIndex];
        const path = ASSETS_DIR + "/" + animal.img;
        animalImg.src = path;
        animalImg.alt = animal.name;
        animalImg.onerror = () => {
          animalImg.style.background = "#fff";
        };
      }

      // ==== –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∫–ª–∏–∫–∞ –ø–æ –±—É–∫–≤–µ ====
      function handleLetterClick(letter) {
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –±—ã—Å—Ç—Ä—ã—Ö –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π (300ms)
        const currentTime = new Date().getTime();
        const timeSinceLastTap = currentTime - lastTapTime;
        if (timeSinceLastTap < 300) return;
        lastTapTime = currentTime;
        
        let placed = false;
        let placedIndex = -1;
        
        // –ò—â–µ–º –ø–µ—Ä–≤—É—é –ø—É—Å—Ç—É—é –ø–æ–∑–∏—Ü–∏—é, –∫—É–¥–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç —ç—Ç–∞ –±—É–∫–≤–∞
        for (let i = 0; i < currentWord.length; i++) {
          if (playerLetters[i] === "" && currentWord[i] === letter) {
            playerLetters[i] = letter;
            placed = true;
            placedIndex = i;
            break;
          }
        }
        
        if (placed) {
          // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
          actionHistory.push({letter: letter, index: placedIndex});
          
          playSound(sndCorrect);
          showMessage("‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!", "success");
        } else {
          playSound(sndWrong);
          showMessage("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –≠—Ç–∞ –±—É–∫–≤–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç", "error");
        }
        
        renderBoxes();
        checkFullWord();
      }

      // –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
      function undoLastAction() {
        if (actionHistory.length === 0) return;
        
        const lastAction = actionHistory.pop();
        playerLetters[lastAction.index] = "";
        
        renderBoxes();
        showMessage("–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ", "info");
      }

      // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ–≤–∞
      function resetCurrentWord() {
        playerLetters = new Array(currentWord.length).fill("");
        actionHistory = [];
        
        renderBoxes();
        showMessage("–°–ª–æ–≤–æ —Å–±—Ä–æ—à–µ–Ω–æ", "info");
      }

      function showMessage(text, type) {
        messageEl.textContent = text;
        
        switch(type) {
          case "success":
            messageEl.style.color = "#006600";
            break;
          case "error":
            messageEl.style.color = "#990000";
            break;
          case "info":
            messageEl.style.color = "#0066cc";
            break;
          default:
            messageEl.style.color = "#333";
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          if (messageEl.textContent === text) {
            messageEl.textContent = "";
          }
        }, 3000);
      }

      function checkFullWord() {
        if (playerLetters.every((ch) => ch !== "") && !showFullWord) {
          showFullWord = true;
          fullWordStartTime = performance.now();
          playSound(sndFirework);
          startParticles();
          
          showMessage(`üéâ –û—Ç–ª–∏—á–Ω–æ! –°–ª–æ–≤–æ "${animals[currentIndex].name}" —Å–æ–±—Ä–∞–Ω–æ!`, "success");
          
          // —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–ª–æ–≤—É
          setTimeout(() => {
            stopParticles();
            nextWord();
          }, 3000);
        }
      }

      // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–ª–æ–≤—É
      function nextWord() {
        currentIndex = (currentIndex + 1) % animals.length;
        currentWord = animals[currentIndex].name.split("");
        playerLetters = new Array(currentWord.length).fill("");
        actionHistory = [];
        showFullWord = false;
        renderAll();
        messageEl.textContent = "";
      }

      // ==== –ó–≤—É–∫–∏ ====
      function playSound(sound) {
        if (!soundsEnabled) return;
        
        try {
          const snd = sound.cloneNode(true);
          snd.volume = sound === audioBg ? 0.2 : 1.0;
          snd.play().catch(() => {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
          });
        } catch (e) {
          console.warn("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞", e);
        }
      }

      function toggleSounds() {
        soundsEnabled = !soundsEnabled;
        soundToggle.textContent = soundsEnabled ? "üîä –ó–≤—É–∫–∏ –≤–∫–ª" : "üîá –ó–≤—É–∫–∏ –≤—ã–∫–ª";
        soundToggle.classList.toggle("active", soundsEnabled);
        
        if (!soundsEnabled) {
          // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∑–≤—É–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
          sndCorrect.pause();
          sndWrong.pause();
          sndFirework.pause();
        }
      }

      function toggleMusic() {
        musicEnabled = !musicEnabled;
        musicToggle.textContent = musicEnabled ? "üéµ –ú—É–∑—ã–∫–∞ –≤–∫–ª" : "üéµ –ú—É–∑—ã–∫–∞ –≤—ã–∫–ª";
        musicToggle.classList.toggle("active", musicEnabled);
        
        if (musicEnabled) {
          audioBg.play().catch(() => {});
        } else {
          audioBg.pause();
        }
      }

      // ==== –ß–∞—Å—Ç–∏—Ü—ã ====
      function rand(min, max) {
        return Math.random() * (max - min) + min;
      }

      function startParticles() {
        particles = [];
        particlesRunning = true;
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        for (let i = 0; i < 60; i++) {
          particles.push({
            x: cx,
            y: cy,
            vx: rand(-6, 6),
            vy: rand(-10, -2),
            life: rand(40, 120),
            size: Math.floor(rand(6, 22)),
            color: `rgb(${Math.floor(rand(0, 255))},${Math.floor(
              rand(0, 255)
            )},${Math.floor(rand(0, 255))})`,
            char: ["*", "‚ú∏", "‚ú¶", "‚òÖ"][Math.floor(rand(0, 4))],
          });
        }
      }
      
      function stopParticles() {
        particlesRunning = false;
        particles = [];
        clearCanvas();
      }

      function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      
      function updateParticles() {
        if (!particlesRunning) return;
        clearCanvas();
        for (let i = particles.length - 1; i >= 0; i--) {
          const p = particles[i];
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.35;
          p.life -= 1;
          ctx.fillStyle = p.color;
          ctx.font = `${p.size}px serif`;
          ctx.fillText(p.char, p.x, p.y);
          if (p.life <= 0) particles.splice(i, 1);
        }
        if (particles.length === 0) particlesRunning = false;
      }

      function loopParticles() {
        updateParticles();
        requestAnimationFrame(loopParticles);
      }
      loopParticles();

      // ==== –†–µ–Ω–¥–µ—Ä –∏ –ø—Ä–∏–≤—è–∑–∫–∏ ====
      function renderAll() {
        loadAnimalImage();
        renderBoxes();
      }

      // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –±—É–∫–≤—ã
      function bindAlphabetClicks() {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–≤–æ–π–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
        const handleLetterEvent = (e) => {
          // –î–ª—è touch —Å–æ–±—ã—Ç–∏–π –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
          if (e.type === 'touchstart') {
            e.preventDefault();
          }
          
          const letter = e.target.dataset.letter;
          if (letter) handleLetterClick(letter);
        };
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ touchstart –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –∏ click –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
        if ('ontouchstart' in window) {
          // –ú–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ touchstart
          alphabetBigDiv.addEventListener("touchstart", handleLetterEvent, { passive: false });
          alphabetSmallDiv.addEventListener("touchstart", handleLetterEvent, { passive: false });
        } else {
          // –î–µ—Å–∫—Ç–æ–ø - –∏—Å–ø–æ–ª—å–∑—É–µ–º click
          alphabetBigDiv.addEventListener("click", handleLetterEvent);
          alphabetSmallDiv.addEventListener("click", handleLetterEvent);
        }
      }

      // Next button
      nextBtn.addEventListener("click", nextWord);

      // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã
      undoBtn.addEventListener("click", undoLastAction);
      
      // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞
      resetBtn.addEventListener("click", resetCurrentWord);

      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–≤—É–∫–æ–º
      soundToggle.addEventListener("click", toggleSounds);
      musicToggle.addEventListener("click", toggleMusic);

      // Start button
      startBtn.addEventListener("click", async () => {
        try {
          await audioBg.play().catch(() => {});
          startBtn.disabled = true;
          startBtn.textContent = "–ò–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞";
        } catch (e) {
          console.warn("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Ñ–æ–Ω–æ–≤—É—é –º—É–∑—ã–∫—É", e);
        }
      });

      // ==== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã ====
      renderAlphabet();
      bindAlphabetClicks();
      renderAll();

      // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
      setInterval(() => {
        placedCount.textContent = playerLetters.filter((x) => x !== "").length;
      }, 200);

      // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º—É–∑—ã–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
      window.addEventListener("beforeunload", () => {
        audioBg.pause();
        audioBg.currentTime = 0;
      });
    </script>
  </body>
</html>
